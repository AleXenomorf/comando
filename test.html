<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Анкета — бонусы</title>
  <style>
    :root { --primary-color: #00b900; --secondary-color: #00e676; }
    body { font-family: Montserrat, system-ui, Arial, sans-serif; background:#0f0f0f; color:#eee; margin:0; }
    .wrap { max-width: 820px; margin: 24px auto; padding: 0 16px; }
    h1 { font-size: 22px; margin: 12px 0 6px; }
    .field { margin: 10px 0; }
    .field label { display:block; font-size:14px; opacity:.9; margin-bottom:6px; }
    .field input {
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid #333; background:#151515; color:#fff;
    }
    .btn { display:inline-block; padding:12px 18px; border-radius:14px; border:none; cursor:pointer; font-weight:800;
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); color:#fff;
      box-shadow: 0 6px 22px rgba(0, 204, 0, .55);
    }
    .hint { opacity:.8; font-size: 12px; }

    /* Overlay */
    #bonuses-overlay{position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.9); z-index:9999}
    #bonuses-overlay .box{
      position:relative; width:min(92vw,780px);
      background:linear-gradient(180deg, #121212 0%, #161616 100%);
      border:1px solid rgba(0, 255, 128, .18);
      border-radius:18px; padding:24px 22px; color:#fff;
      box-shadow:0 20px 60px rgba(0,0,0,.55), 0 0 0 1px rgba(0,255,128,.08) inset;
    }
    .overlay-title{margin:0 0 6px; font-size:22px; font-weight:800; letter-spacing:.2px}
    .overlay-intro{opacity:.9; margin:0 0 10px}
    .overlay-list{margin:6px 0 0 18px; line-height:1.8}
    .overlay-zip{margin-top:12px}
    .dl-link{ display:inline-block; padding:10px 14px; border-radius:14px; text-decoration:none; color:#fff;
      background:linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      box-shadow: 0 6px 22px rgba(0, 204, 0, .55); font-weight:700; }
    .overlay-close{ position:absolute; top:10px; right:10px; width:36px; height:36px; border-radius:10px;
      border:1px solid rgba(0,255,128,.3); background:rgba(255,255,255,.06); color:#fff; font-size:22px; line-height:32px; cursor:pointer;
      box-shadow:0 6px 22px rgba(0,0,0,.35); }
    .overlay-close:hover{ background:rgba(255,255,255,.12); }
  </style>

  <script>
  // === НАСТРОЙКИ GOOGLE FORM (ЗАПОЛНИТЕ 1 РАЗ) ==============================
  // 1) Замените FORM_ID на ID вашей формы (action = .../forms/d/e/FORM_ID/formResponse)
  // 2) Вставьте entry.* ID полей (из prefill-ссылки): имя/фамилия/email/телефон/промокод
  const GOOGLE = {
    action: "https://docs.google.com/forms/d/e/FORM_ID_HERE/formResponse",
    entry: {
      name:   "entry.XXXXXXXXX",
      surname:"entry.YYYYYYYYY",
      email:  "entry.ZZZZZZZZZ",
      phone:  "entry.AAAAAAAA",
      promo:  "entry.BBBBBBBBB" // можно не заполнять, если такого поля нет
    }
  };
  // ==========================================================================

  // Helper: detect "БОНУСЫ" mode from URL or storage
  function isBonusFlow(){
    function norm(x){ return (x||'').toString().trim().toUpperCase(); }
    var ps = ""; try { ps = new URLSearchParams(location.search).get('ps') || ""; } catch(_){}
    var ls = ""; try { ls = localStorage.getItem('selectedPackageShort') || ""; } catch(_){}
    var ss = ""; try { ss = sessionStorage.getItem('lastSelectedPackageShort') || ""; } catch(_){}
    return norm(ps)==="БОНУСЫ" || norm(ls)==="БОНУСЫ" || norm(ss)==="БОНУСЫ";
  }

  // Files to download (exact names, Cyrillic)
  var files = [
    "МЕНЮ 1200.pdf",
    "МЕНЮ 1500.pdf",
    "МЕНЮ 2000.pdf",
    "тренировка для женщин в тренажерном зале - тренировка.pdf",
    "тренировка для мужчин в тренажерном зале - тренировка.pdf"
  ];

  function buildDownloads(){
    var box = document.getElementById('bonuses-overlay-content');
    if (!box) return;
    var closeBtn = '<button class="overlay-close" data-close-overlay aria-label="Закрыть">×</button>';
    var h2 = '<h2 class="overlay-title">Ваши бонусы</h2>';
    var intro = '<p class="overlay-intro">Скачайте материалы прямо сейчас:</p>';
    var list = '<ul class="overlay-list">' + files.map(function(f){
      var u = encodeURI(f);
      return '<li><a class="dl-link" href="'+u+'" download>'+f+'</a></li>';
    }).join('') + '</ul>';
    box.innerHTML = closeBtn + h2 + intro + list;
  }

  function showDownloadsOverlay(){
    try { buildDownloads(); } catch(_){}
    var ov = document.getElementById('bonuses-overlay');
    if (ov) { ov.style.display = 'flex'; try { window.scrollTo({top:0, behavior:'smooth'}); } catch(_){ } }
  }

  function showAckAndRedirect(){
    var box = document.getElementById('bonuses-overlay-content');
    var ov = document.getElementById('bonuses-overlay');
    if (box){
      box.innerHTML = '<button class="overlay-close" data-close-overlay aria-label="Закрыть">×</button>' +
                      '<h2 class="overlay-title">Запрос был получен</h2>' +
                      '<p class="overlay-intro">Мы свяжемся с вами в ближайшее время.</p>';
    }
    if (ov){ ov.style.display = 'flex'; try { window.scrollTo({top:0, behavior:"smooth"}); } catch(_){} }
    setTimeout(function(){ location.href = 'https://alexenomorf.github.io/comando/'; }, 3000);
  }

  document.addEventListener('click', function(e){
    var btn = e.target.closest('[data-close-overlay]');
    if(!btn) return;
    e.preventDefault();
    var ov = document.getElementById('bonuses-overlay');
    if (ov) ov.style.display = 'none';
    location.href = 'https://alexenomorf.github.io/comando/';
  });
  </script>
</head>
<body>
  <!-- Hidden iframe for Google Forms submit -->
  <iframe id="hidden_iframe" name="hidden_iframe" style="display:none;"></iframe>

  <div class="wrap">
    <h1>Анкета</h1>
    <form id="gform" action="#" method="post" target="hidden_iframe" novalidate>
      <div class="field">
        <label>Имя</label>
        <input id="ui_name" name="ui.name" required />
      </div>
      <div class="field">
        <label>Фамилия</label>
        <input id="ui_surname" name="ui.surname" required />
      </div>
      <div class="field">
        <label>Email</label>
        <input id="ui_email" name="ui.email" type="email" required />
      </div>
      <div class="field">
        <label>Телефон</label>
        <input id="ui_phone" name="ui.phone" required />
      </div>
      <div class="field">
        <label>Промокод <span class="hint">(необязательно)</span></label>
        <input id="ui_promo" name="ui.promo" />
      </div>
      <div class="field">
        <button class="btn" type="submit" id="submitBtn">Отправить заявку</button>
      </div>
    </form>
  </div>

  <!-- Overlay -->
  <div id="bonuses-overlay">
    <div class="box" id="bonuses-overlay-content"></div>
  </div>

  <script>
  // Wire Google Form action + map visible UI fields => hidden entry.* before submit
  (function(){
    var form = document.getElementById('gform');
    if (!form) return;
    // Set action
    if (GOOGLE && GOOGLE.action && GOOGLE.action.indexOf("FORM_ID_HERE") === -1) {
      form.action = GOOGLE.action;
    }

    var submittedOnce = false;
    var submitBtn = document.getElementById('submitBtn');

    function firstEmpty(){
      var fields = form.querySelectorAll('input[required]');
      for (var i=0;i<fields.length;i++){
        var v = (fields[i].value||'').trim();
        if (!v) return fields[i];
      }
      return null;
    }

    function addHidden(name, value){
      if (!name) return;
      var input = document.createElement('input');
      input.type = 'hidden';
      input.name = name;
      input.value = value || '';
      form.appendChild(input);
    }

    form.addEventListener('submit', function(e){
      var bad = firstEmpty();
      if (bad){ e.preventDefault(); bad.focus(); bad.style.outline='2px solid #ff6b6b'; setTimeout(function(){bad.style.outline=''},1200); return; }
      if (submittedOnce){ e.preventDefault(); return; }
      submittedOnce = true;
      if (submitBtn){ submitBtn.disabled = true; submitBtn.setAttribute('aria-busy','true'); submitBtn.style.opacity='.7'; submitBtn.style.pointerEvents='none'; }

      // Build hidden entry.* fields from UI
      try {
        addHidden(GOOGLE.entry.name,    document.getElementById('ui_name').value);
        addHidden(GOOGLE.entry.surname, document.getElementById('ui_surname').value);
        addHidden(GOOGLE.entry.email,   document.getElementById('ui_email').value);
        addHidden(GOOGLE.entry.phone,   document.getElementById('ui_phone').value);
        if (GOOGLE.entry.promo) addHidden(GOOGLE.entry.promo, document.getElementById('ui_promo').value);
      } catch(_){}

      // Branch: bonus vs non-bonus
      if (isBonusFlow()) { try { showDownloadsOverlay(); } catch(_){ } }
      else { try { showAckAndRedirect(); } catch(_){ } }
      // Do not prevent default; post to hidden_iframe
    }, true);

    // Fallbacks
    if (submitBtn){
      submitBtn.addEventListener('click', function(){
        if (submittedOnce) return;
        var bad = (function(){ var f=form.querySelectorAll('input[required]'); for (var i=0;i<f.length;i++){ if(!(f[i].value||'').trim()) return true; } return false; })();
        if (!bad){
          if (isBonusFlow()) { try { showDownloadsOverlay(); } catch(_){ } }
          else { try { showAckAndRedirect(); } catch(_){ } }
        }
      }, true);
    }

    var ifr = document.getElementById('hidden_iframe');
    if (ifr){
      ifr.addEventListener('load', function(){
        if (isBonusFlow()) { try { showDownloadsOverlay(); } catch(_){ } }
        else { try { showAckAndRedirect(); } catch(_){ } }
      });
    }
  })();
  </script>
</body>
</html>
