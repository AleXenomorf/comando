<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ö–æ–Ω—Ç–∞–∫—Ç—ã ‚Äî DEBUG</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;900&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Montserrat',sans-serif;background:#1f1f1f;color:#fff;margin:0;padding:0}
    .wrap{max-width:860px;margin:0 auto;padding:24px}
    .card{background:#2a2a2a;border-radius:14px;padding:24px;box-shadow:0 10px 30px rgba(0,0,0,.3)}
    h1{font-size:22px;margin:0 0 12px}
    label{display:block;margin:12px 0 6px}
    input,button,textarea{font-family:inherit;font-size:16px}
    input,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #555;background:#181818;color:#fff}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row .col{display:block}
    .actions{margin-top:16px;display:flex;gap:12px}
    button{background:#00cc00;border:none;color:#111;padding:10px 16px;border-radius:999px;font-weight:700;cursor:pointer}
    button.secondary{background:#888;color:#111}
    pre{background:#0f0f0f;border-radius:10px;padding:12px;overflow:auto;max-height:260px}
    .ok{color:#8dff8d}
    .err{color:#ffb3b3}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>–û—Ç–ª–∞–¥–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Proxy + Google Forms</h1>
      <div class="row">
        <div class="col">
          <label>–ò–º—è</label><input id="firstName" placeholder="–ò–≤–∞–Ω">
        </div>
        <div class="col">
          <label>–§–∞–º–∏–ª–∏—è</label><input id="lastName" placeholder="–ò–≤–∞–Ω–æ–≤">
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>Email</label><input id="email" type="email" placeholder="ivan@example.com">
        </div>
        <div class="col">
          <label>WhatsApp</label><input id="whatsapp" placeholder="+77001234567">
        </div>
      </div>

      <div class="row" style="margin-top:16px">
        <div class="col">
          <label>PROXY_URL</label><input id="proxyUrl" placeholder="https://<your-proxy-endpoint>">
        </div>
        <div class="col">
          <label>APP_KEY (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω –≤ –ø—Ä–æ–∫—Å–∏)</label><input id="appKey" placeholder="<your_app_key>">
        </div>
      </div>

      <div class="actions">
        <button id="testProxy">–¢–µ—Å—Ç: —Ç–æ–ª—å–∫–æ Proxy</button>
        <button id="sendAll">–û—Ç–ø—Ä–∞–≤–∏—Ç—å (Proxy + Google Forms)</button>
        <button class="secondary" id="clearLog">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
      </div>

      <h3>–õ–æ–≥</h3>
      <pre id="log"></pre>
    </div>
  </div>

  <script>
    const logEl = document.getElementById('log');
    function log(msg, type='') {
      const line = document.createElement('div');
      line.className = type === 'err' ? 'err' : type === 'ok' ? 'ok' : '';
      line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      logEl.appendChild(line);
      logEl.scrollTop = logEl.scrollHeight;
    }
    function getVals() {
      return {
        firstName: document.getElementById('firstName').value.trim() || 'Test',
        lastName:  document.getElementById('lastName').value.trim() || 'User',
        email:     document.getElementById('email').value.trim() || 'test@example.com',
        whatsapp:  document.getElementById('whatsapp').value.trim() || '+70000000000',
        PROXY_URL: document.getElementById('proxyUrl').value.trim(),
        APP_KEY:   document.getElementById('appKey').value.trim()
      };
    }

    const googleForms = {
      formUrl: "https://docs.google.com/forms/d/e/1FAIpQLScf0Axx5RUF20o3DuZ1YzO3bj0oP75GlJgTqLEIDTB9kNy_AA/formResponse",
      fieldIds: {
        firstName: "entry.575542865",
        lastName:  "entry.1529853970",
        email:     "entry.63446999",
        whatsapp:  "entry.826076263"
      }
    };

    async function sendToGoogleForms(data) {
      const formData = new URLSearchParams();
      formData.append(googleForms.fieldIds.firstName, data.firstName);
      formData.append(googleForms.fieldIds.lastName,  data.lastName);
      formData.append(googleForms.fieldIds.email,     data.email);
      formData.append(googleForms.fieldIds.whatsapp,  data.whatsapp);
      formData.append('fvv', '1'); formData.append('pageHistory','0'); formData.append('submit','Submit');

      const resp = await fetch(googleForms.formUrl, {
        method: 'POST', mode: 'no-cors',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: formData.toString()
      });
      log('Google Forms –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ (no-cors, —Å—Ç–∞—Ç—É—Å —Å–∫—Ä—ã—Ç –±—Ä–∞—É–∑–µ—Ä–æ–º).', 'ok');
      return resp;
    }

    async function sendToProxy(PROXY_URL, APP_KEY, message) {
      log(`POST ${PROXY_URL}`);
      try {
        const resp = await fetch(PROXY_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(APP_KEY ? {'X-App-Key': APP_KEY} : {})
          },
          body: JSON.stringify({
            chat_id: "1208941214",
            text: message,
            parse_mode: 'Markdown'
          })
        });
        const text = await resp.text().catch(()=>'');
        log(`Proxy –æ—Ç–≤–µ—Ç: ${resp.status} ${resp.statusText} ‚Äî ${text.slice(0,300)}`, resp.ok ? 'ok' : 'err');
        return { ok: resp.ok, status: resp.status, text };
      } catch (e) {
        log('Fetch error: ' + String(e), 'err');
        return { ok:false, status:0, text:String(e) };
      }
    }

    document.getElementById('testProxy').onclick = async ()=>{
      const v = getVals();
      if (!v.PROXY_URL) return alert('–£–∫–∞–∂–∏ PROXY_URL');
      const message = "–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏ (–∫–Ω–æ–ø–∫–∞ –¢–µ—Å—Ç)";
      await sendToProxy(v.PROXY_URL, v.APP_KEY, message);
    };

    document.getElementById('sendAll').onclick = async ()=>{
      const v = getVals();
      if (!v.PROXY_URL) return alert('–£–∫–∞–∂–∏ PROXY_URL');
      const message = `üìã *–ù–æ–≤—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ*\n\nüë§ *–ò–º—è:* ${v.firstName} ${v.lastName}\nüìß *Email:* ${v.email}\nüì± *WhatsApp:* ${v.whatsapp}`;
      const r = await sendToProxy(v.PROXY_URL, v.APP_KEY, message);
      if (r.ok) {
        await sendToGoogleForms(v);
        log('–ì–æ—Ç–æ–≤–æ ‚úÖ', 'ok');
      } else {
        log('–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ –ø—Ä–æ–∫—Å–∏.', 'err');
      }
    };

    document.getElementById('clearLog').onclick = ()=>{ logEl.innerHTML = ''; };
  </script>
</body>
</html>
